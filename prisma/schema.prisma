// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
}

// 用户模型 - 与 Clerk 用户同步
model User {
  id        BigInt   @id @default(autoincrement()) // 主键 ID，自增
  clerkId   String   @unique // Clerk 用户 ID
  email     String   @unique // 邮箱
  username  String? // 用户名
  firstName String? // 名字
  lastName  String? // 姓氏
  imageUrl  String? // 头像 URL
  createdAt DateTime @default(now()) // 创建时间
  updatedAt DateTime @updatedAt // 更新时间

  // 关联用户的使用记录
  usages Usage[]

  @@map("users")
}

// 订阅模型 - 记录用户的订阅信息
model Subscription {
  id                 BigInt    @id @default(autoincrement())
  userId             String    @unique @map("user_id") // Clerk 用户 ID
  creemCustomerId    String?   @map("creem_customer_id") // Creem 客户 ID
  creemSubscriptionId String?  @map("creem_subscription_id") // Creem 订阅 ID
  productId          String?   @map("product_id") // 产品 ID
  status             String    @default("inactive") @db.VarChar(32) // 订阅状态
  credits            Int       @default(0) // 剩余积分
  currentPeriodStart DateTime? @map("current_period_start")
  currentPeriodEnd   DateTime? @map("current_period_end")
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")

  @@index([creemCustomerId])
  @@index([creemSubscriptionId])
  @@map("subscriptions")
}

// 使用记录模型 - 记录用户的任务使用情况
model Usage {
  id         BigInt    @id @default(autoincrement()) // 主键 ID，自增
  userId     String    @map("user_id") // Clerk 用户 ID
  taskType   String    @map("task_type") @db.VarChar(32) // 任务类型
  taskUsed   Int       @map("task_used") // 消费的积分数量
  taskId     String    @unique @map("task_id") @db.VarChar(64) // 任务 ID
  inputMeta  Json?     @map("input_meta") // 输入元数据
  outputMeta Json?     @map("output_meta") // 输出元数据
  completeAt DateTime? @map("complete_at") // 任务完成时间
  showPublic Int       @default(1) @map("show_public") // 公开展示状态：1=公开，0=私有
  createdAt  DateTime  @default(now()) @map("created_at") // 创建时间
  updatedAt  DateTime  @updatedAt @map("updated_at") // 更新时间
  deletedAt  DateTime? @map("deleted_at") // 软删除时间
  liked      Int       @default(1) @db.TinyInt // 是否喜欢：1=是，0=否

  // 关联用户（通过 clerkId）
  user User @relation(fields: [userId], references: [clerkId])

  @@index([userId])
  @@index([userId, createdAt(sort: Desc)]) // 优化按用户ID和创建时间降序查询
  @@index([completeAt]) // 优化按完成时间查询（用于筛选未完成任务）
  @@map("usages")
}
