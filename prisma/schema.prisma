// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client"
  output   = "../generated/prisma"
}

datasource db {
  provider = "mysql"
}

// 用户模型 - 与 Clerk 用户同步
model User {
  id            BigInt   @id @default(autoincrement()) // 主键 ID，自增
  clerkId       String   @unique // Clerk 用户 ID
  email         String   @unique // 邮箱
  username      String? // 用户名
  firstName     String? // 名字
  lastName      String? // 姓氏
  imageUrl      String? // 头像 URL
  totalCredits  Int      @default(0) @map("total_credits") // 总积分
  usedCredits   Int      @default(0) @map("used_credits") // 已用积分
  hasPurchased  Boolean  @default(false) @map("has_purchased") // 是否购买过
  createdAt     DateTime @default(now()) // 创建时间
  updatedAt     DateTime @updatedAt // 更新时间

  // 关联
  usages        Usage[]
  subscriptions Subscription[]

  @@map("users")
}

// 交易记录模型 - 记录用户的支付交易（一个用户可以有多条）
model Subscription {
  id                  BigInt    @id @default(autoincrement())
  userId              String    @map("user_id") // Clerk 用户 ID
  checkoutId          String?   @unique @map("checkout_id") // Creem checkout ID
  creemCustomerId     String?   @map("creem_customer_id") // Creem 客户 ID
  creemSubscriptionId String?   @map("creem_subscription_id") // Creem 订阅 ID
  productId           String?   @map("product_id") // 产品 ID
  amount              Int       @default(0) // 金额（分）
  currency            String    @default("USD") @db.VarChar(8) // 货币
  credits             Int       @default(0) // 购买的积分数量
  status              String    @default("pending") @db.VarChar(32) // pending, completed, failed, refunded
  paidAt              DateTime? @map("paid_at") // 支付时间
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  // 关联用户
  user User @relation(fields: [userId], references: [clerkId])

  @@index([userId])
  @@index([status])
  @@index([creemCustomerId])
  @@index([creemSubscriptionId])
  @@map("subscriptions")
}

// 使用记录模型 - 记录用户的任务使用情况
model Usage {
  id         BigInt    @id @default(autoincrement()) // 主键 ID，自增
  userId     String    @map("user_id") // Clerk 用户 ID
  taskType   String    @map("task_type") @db.VarChar(32) // 任务类型
  taskUsed   Int       @map("task_used") // 消费的积分数量
  taskId     String    @unique @map("task_id") @db.VarChar(64) // 任务 ID
  inputMeta  Json?     @map("input_meta") // 输入元数据
  outputMeta Json?     @map("output_meta") // 输出元数据
  completeAt DateTime? @map("complete_at") // 任务完成时间
  showPublic Int       @default(1) @map("show_public") // 公开展示状态：1=公开，0=私有
  createdAt  DateTime  @default(now()) @map("created_at") // 创建时间
  updatedAt  DateTime  @updatedAt @map("updated_at") // 更新时间
  deletedAt  DateTime? @map("deleted_at") // 软删除时间
  liked      Int       @default(1) @db.TinyInt // 是否喜欢：1=是，0=否

  // 关联用户（通过 clerkId）
  user User @relation(fields: [userId], references: [clerkId])

  @@index([userId])
  @@index([userId, createdAt(sort: Desc)]) // 优化按用户ID和创建时间降序查询
  @@index([completeAt]) // 优化按完成时间查询（用于筛选未完成任务）
  @@map("usages")
}
